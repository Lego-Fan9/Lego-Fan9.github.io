<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SWGoH Sprite Downloads">
    <meta name="author" content="LegoFan9">
    <title>Download Sprites</title>
    <link rel="icon" href="../../favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="/src/nav-bar.css">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-X7TKZ22H21"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-X7TKZ22H21');
    </script>
</head>

<body>
    <header>
        <nav>
            <div class="nav-container">
                <div class="logo">SWGoH Updates</div>
                <button class="menu-toggle" aria-label="Toggle menu">â˜°</button>
                <ul class="nav-links">
                    <li><a href="javascript:history.back()">Back</a></li>
                    <li><a href="/">Home</a></li>
                    <li><a href="/swgoh-portrait-maker/">SWGoH Portrait Maker</a></li>
                    <li><a href="/swgoh-updates/">SWGoH Updates</a></li>
                    <li><a href="/about/">About</a></li>
                </ul>
            </div>
        </nav>
        <div style="height: 25px;"></div>
    </header>
    <main>
        <p id="status">Waking server...</p>
        <p id="checksumInfo"></p>
        <button id="startDownloadBtn" class="app-link" disabled style="display: none;">Start Download</button>
    </main>

    <script>
        document.querySelector(".menu-toggle").addEventListener("click", () => {
            document.querySelector(".nav-links").classList.toggle("show");
        });
    </script>

    <script>
        const baseDownloadURL = "https://legofan9-sprite-server.onrender.com";
        const statusEl = document.getElementById("status");
        const checksumEl = document.getElementById("checksumInfo");
        const startBtn = document.getElementById("startDownloadBtn");

        function checkRateLimit(response) {
            if (response.status === 429) {
                statusEl.textContent = "You have reached the download limit. Please wait before trying again.";
                throw new Error("429");
            }
        }

        async function wakeServer() {
            try {
                statusEl.textContent = "Waking server (this may take up to 50 seconds)...";
                const res = await fetch(`${baseDownloadURL}/Wake`);
                if (!res.ok) throw new Error("Failed to wake server");

                statusEl.textContent = "Server awake! Fetching checksum...";
                pollChecksum();

            } catch (err) {
                console.error(err);
                statusEl.textContent = "Error waking server.";
            }
        }

        async function pollChecksum() {
            try {
                const res = await fetch(`${baseDownloadURL}/Checksum`);
                if (!res.ok) throw new Error("Failed to fetch checksum");

                const checksum = (await res.text()).trim();

                checksumEl.textContent = `File checksum: ${checksum}`;
                statusEl.textContent = "Download ready!";
                startBtn.style.display = "";
                startBtn.disabled = false;

            } catch (err) {
                console.error(err);
                statusEl.textContent = "Error retrieving checksum.";
            }
        }

        startBtn.addEventListener("click", async () => {
            try {
                statusEl.textContent = "Starting download...";
                const res = await fetch(`${baseDownloadURL}/Download`);
                checkRateLimit(res);
                statusEl.textContent = "Done!";
                window.location.href = `${baseDownloadURL}/Download`;

            } catch (err) {
                if (err.message === "429") {
                    statusEl.textContent = "You have been rate limited. Try again in a couple minutes."
                }
                if (err.message !== "429") {
                    console.error(err);
                    statusEl.textContent = "Error starting download.";
                }
            }
        });

        wakeServer();
    </script>
</body>

</html>